# Immich ë°±ì—… ì „ëµ (Restic + AWS S3 Glacier Deep Archive)

> ğŸ’¡ **ëª©ì **: Immich ë°ì´í„°ì˜ ì¥ê¸° ë³´ê´€ ë°±ì—… (ì›” 1íšŒ)
>
> **ì „ëµ**: Restic ì¦ë¶„ ë°±ì—… â†’ AWS S3 Glacier Deep Archive
>
> **ë¹„ìš© ìµœì í™”**: ê°ì²´ ìˆ˜ ìµœì†Œí™” (ìˆ˜ë§Œ ê°œ â†’ ìˆ˜ë°± ê°œ)

---

## ğŸ“Š í˜„ì¬ ë°±ì—… í”Œë¡œìš°

```
Immich ì›ë³¸ ë°ì´í„° (62GB)
    â†“ restic backup (ì¦ë¶„, ì••ì¶•, dedupe)
Restic ë¡œì»¬ ì €ì¥ì†Œ (63GB) - /mnt/exthdd02/immich-archive-restic/restic
    â†“ mc mirror (ì›” 1íšŒ)
AWS S3 Glacier Deep Archive
```

### í¬ë¡ íƒ­ ìŠ¤ì¼€ì¤„ (ë§¤ì›” 1ì¼ ìƒˆë²½)

```
1:00 AM - Restic ë°±ì—… (11ë¶„ ì†Œìš”)
2:00 AM - S3 ë™ê¸°í™” (ìµœì´ˆ 1ì‹œê°„ 41ë¶„, ì¦ë¶„ì€ ë¹ ë¦„)
4:00 AM - Docker ë³¼ë¥¨ ë°±ì—…
```

---

## ğŸ“œ ë³€ê²½ íˆìŠ¤í† ë¦¬

### 1ë‹¨ê³„: ì§ì ‘ ë°±ì—… ë°©ì‹ (2024 ~ 2025-10)

**ë°©ë²•**: MinIO â†’ S3 ì§ì ‘ ë™ê¸°í™” (`mc mirror`)

- **ì¥ì **: êµ¬ì¡° ë‹¨ìˆœ, ì„¤ì • ê°„í¸
- **ë¬¸ì œì **:
    - ê°ì²´ ìˆ˜ í­íƒ„ (25,950ê°œ íŒŒì¼ â†’ 25,950ê°œ S3 ê°ì²´)
    - S3 ìš”ì²­ ë¹„ìš© ì¦ê°€ ìš°ë ¤
    - ì¦ë¶„ ë°±ì—… ë¶ˆê°€ (ì „ì²´ ë™ê¸°í™”ë§Œ ê°€ëŠ¥)

### 2ë‹¨ê³„: Restic ë„ì… (2025-10-09)

**ì„ íƒ ì´ìœ **:

- âœ… ì¦ë¶„ ë°±ì—… + ì¤‘ë³µ ì œê±°
- âœ… ì••ì¶• ë° ì•”í˜¸í™” ê¸°ë³¸ ì§€ì›
- âœ… Pack íŒŒì¼ë¡œ ê°ì²´ ìˆ˜ ìµœì†Œí™” (64MB ë‹¨ìœ„)
- âœ… MinIO ì§ì ‘ ì—°ê²° ê°€ëŠ¥ (ìºì‹œ ë¶ˆí•„ìš”)

**í…ŒìŠ¤íŠ¸ ê²°ê³¼**:

| ë‚ ì§œ | ì‘ì—… | ê²°ê³¼ |
| --- | --- | --- |
| 2025-10-10 | ì´ˆê¸° ë°±ì—… | 50.0GB (779ê°œ pack íŒŒì¼) |
| 2025-11-01 | ì¦ë¶„ ë°±ì—… | +2.9GB (424ê°œ ì‹ ê·œ, 6ê°œ ë³€ê²½) |
| 2025-12-27 | ì¦ë¶„ ë°±ì—… | +2.6GB (246ê°œ ì‹ ê·œ, 6ê°œ ë³€ê²½) |

**ë¹„ìš© íš¨ê³¼**:

- ê°ì²´ ìˆ˜: 25,950ê°œ â†’ ì•½ 1,000ê°œ (95% ê°ì†Œ)
- ì €ì¥ ìš©ëŸ‰: ì••ì¶• ë° ì¤‘ë³µ ì œê±°ë¡œ íš¨ìœ¨ ì¦ê°€

### 3ë‹¨ê³„: ì™„ì „ ìë™í™” (2025-12-27)

**êµ¬í˜„ ë‚´ìš©**:

- âœ… ë°±ì—… ìŠ¤í¬ë¦½íŠ¸ ì™„ì„± (`restic-backup-immich.sh`)
- âœ… S3 ë™ê¸°í™” ìŠ¤í¬ë¦½íŠ¸ ì™„ì„± (`restic-sync-to-s3.sh`)
- âœ… í¬ë¡ íƒ­ ìë™í™” ë“±ë¡
- âœ… ë¡œê·¸ ì‹œìŠ¤í…œ êµ¬ì¶• (ìƒì„¸/ìš”ì•½ ë¶„ë¦¬)

**ì‹¤ì¸¡ ì„±ëŠ¥**:

- Restic ë°±ì—…: **11ë¶„** (62GB â†’ 2.6GB ì¦ë¶„)
- S3 ìµœì´ˆ ë™ê¸°í™”: **1ì‹œê°„ 41ë¶„** (63GB)
- S3 ì¦ë¶„ ë™ê¸°í™”: ì˜ˆìƒ í›¨ì”¬ ë¹ ë¦„ (ë‹¤ìŒ ë‹¬ í™•ì¸ ì˜ˆì •)

**ì£¼ìš” íŠ¸ëŸ¬ë¸”ìŠˆíŒ…**:

- **ë¬¸ì œ**: S3 ì—…ë¡œë“œ ì‹¤íŒ¨ (ë¡œê·¸ì—ëŠ” ì„±ê³µ í‘œì‹œ, ì‹¤ì œ íŒŒì¼ ì—†ìŒ)
- **ì›ì¸**: `sudo`ë¡œ ì‹¤í–‰ ì‹œ rootê°€ restic íŒŒì¼(ê¶Œí•œ 400) ì½ê¸° ë¶ˆê°€
- **í•´ê²°**: `sudo` ì œê±°, ì¼ë°˜ ì‚¬ìš©ìë¡œ ì‹¤í–‰

---

## âš™ï¸ ìš´ì˜ ê°€ì´ë“œ

### ìŠ¤í¬ë¦½íŠ¸ ì„¤ì¹˜

```bash
# 1. restic-backup-immich.sh ì„¤ì¹˜
sudo cp /path/to/onyu-home/storage/restic-backup-immich.sh /usr/local/bin/
sudo chmod +x /usr/local/bin/restic-backup-immich.sh

# 2. restic-sync-to-s3.sh ì„¤ì¹˜
sudo cp /path/to/onyu-home/storage/restic-sync-to-s3.sh /usr/local/bin/
sudo chmod +x /usr/local/bin/restic-sync-to-s3.sh
```

### í¬ë¡ íƒ­ ì„¤ì •

> âš ï¸ **ì¤‘ìš”**: restic íŒŒì¼ ê¶Œí•œ ë¬¸ì œë¡œ ì¸í•´ **sudo ì—†ì´** ì‹¤í–‰í•´ì•¼ í•¨!

```bash
crontab -e  # ì¼ë°˜ ì‚¬ìš©ì í¬ë¡ íƒ­
```

```cron
# ë§¤ì›” 1ì¼ ìƒˆë²½ 1ì‹œ: Resticìœ¼ë¡œ Immich ë°±ì—… (ë¡œì»¬) - ì•½ 11ë¶„ ì†Œìš”
0 1 1 * * /usr/local/bin/restic-backup-immich.sh

# ë§¤ì›” 1ì¼ ìƒˆë²½ 2ì‹œ: Restic ì €ì¥ì†Œë¥¼ S3 Glacier Deep Archiveë¡œ ë™ê¸°í™”
# ìµœì´ˆ: 1ì‹œê°„ 41ë¶„ ì†Œìš”, ì¦ë¶„: í›¨ì”¬ ë¹ ë¦„
0 2 1 * * /usr/local/bin/restic-sync-to-s3.sh

# ë§¤ì›” 1ì¼ ìƒˆë²½ 4ì‹œ: Docker ë³¼ë¥¨ ë°±ì—… (2ì‹œê°„ ì—¬ìœ )
0 4 1 * * /usr/local/bin/docker-volume-backup.sh
```

### ë¡œê·¸ í™•ì¸

```bash
# Restic ë°±ì—… ë¡œê·¸
tail -f ~/.log/restic-backup-immich.log              # ìƒì„¸ ë¡œê·¸
tail -f ~/.log/restic-backup-immich-summary.log      # ìš”ì•½ ë¡œê·¸ (ê²°ê³¼ë§Œ)

# S3 ë™ê¸°í™” ë¡œê·¸
tail -f ~/.log/restic-sync-to-s3.log                 # ìƒì„¸ ë¡œê·¸
tail -f ~/.log/restic-sync-to-s3-summary.log         # ìš”ì•½ ë¡œê·¸ (ê²°ê³¼ë§Œ)
```

**ìš”ì•½ ë¡œê·¸ ì˜ˆì‹œ**:

```
[2025-12-27 02:00:00] ===== Restic to S3 Sync Start =====
[2025-12-27 02:00:00] --> Starting sync of restic repository to S3
[2025-12-27 03:41:00] --> S3 sync completed successfully
[2025-12-27 03:41:00] --> Repository size: 63G
[2025-12-27 03:41:00] ===== Restic to S3 Sync End =====
[2025-12-27 03:41:00] --> Total duration: 101m 0s
```

### ìŠ¤ëƒ…ìƒ· ê´€ë¦¬

```bash
# ìŠ¤ëƒ…ìƒ· ëª©ë¡ í™•ì¸
restic -r /mnt/exthdd02/immich-archive-restic/restic --insecure-no-password snapshots

# íŠ¹ì • ìŠ¤ëƒ…ìƒ· ì‚­ì œ (ì˜¤ë˜ëœ ë°±ì—… ì •ë¦¬)
restic -r /mnt/exthdd02/immich-archive-restic/restic --insecure-no-password forget <snapshot-id>

# ì •ì±… ê¸°ë°˜ ìë™ ì‚­ì œ (ì˜ˆ: ìµœê·¼ 6ê°œì›”ë§Œ ìœ ì§€)
restic -r /mnt/exthdd02/immich-archive-restic/restic --insecure-no-password forget --keep-monthly 6 --prune
```

---

## ğŸ”§ ë³µêµ¬ ë°©ë²•

### 1. S3ì—ì„œ Restic ì €ì¥ì†Œ ë³µì›

```bash
# S3 â†’ ë¡œì»¬ë¡œ ì €ì¥ì†Œ ë‹¤ìš´ë¡œë“œ
mc mirror aws/immich-archive-restic /mnt/exthdd02/immich-archive-restic/restic
```

### 2. ìŠ¤ëƒ…ìƒ· í™•ì¸

```bash
# ìŠ¤ëƒ…ìƒ· ëª©ë¡ í™•ì¸
restic -r /mnt/exthdd02/immich-archive-restic/restic --insecure-no-password snapshots
```

### 3. ë°ì´í„° ë³µì›

```bash
# ìµœì‹  ìŠ¤ëƒ…ìƒ· ë³µì›
restic -r /mnt/exthdd02/immich-archive-restic/restic --insecure-no-password restore latest --target /mnt/exthdd02/restored-immich

# íŠ¹ì • ìŠ¤ëƒ…ìƒ· ë³µì›
restic -r /mnt/exthdd02/immich-archive-restic/restic --insecure-no-password restore <snapshot-id> --target /mnt/exthdd02/restored-immich
```

**ì°¸ê³  ë§í¬**: [Glacier ë³µì› ë°©ë²•](https://goodahn.tistory.com/280)

---

## âš ï¸ í•µì‹¬ ì£¼ì˜ì‚¬í•­

### 1. íŒŒì¼ ê¶Œí•œ ë¬¸ì œ

Restic ì €ì¥ì†Œ íŒŒì¼ì€ ë³´ì•ˆì„ ìœ„í•´ **400 ê¶Œí•œ** (ì†Œìœ ìë§Œ ì½ê¸°)ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤.

```bash
-r-------- 1 user user 155 Oct 10 08:57 /mnt/exthdd02/immich-archive-restic/restic/config
```

- âŒ **`sudo`ë¡œ ì‹¤í–‰**: rootê°€ íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ì–´ ì—…ë¡œë“œ ì‹¤íŒ¨
- âœ… **ì¼ë°˜ ì‚¬ìš©ìë¡œ ì‹¤í–‰**: íŒŒì¼ ì†Œìœ ìê°€ ì½ì„ ìˆ˜ ìˆì–´ ì •ìƒ ì‘ë™

### 2. S3 Glacier Deep Archive ì œì•½

| í•­ëª© | ë‚´ìš© |
| --- | --- |
| ì €ì¥ ìš”ê¸ˆ | $0.0012/GB/ì›” (ì„œìš¸ ë¦¬ì „) |
| ìµœì†Œ ì €ì¥ ê¸°ê°„ | **180ì¼** (ì¡°ê¸° ì‚­ì œ ì‹œì—ë„ 6ê°œì›” ìš”ê¸ˆ ë¶€ê³¼) |
| ë³µì› ì†Œìš” ì‹œê°„ | ìµœëŒ€ 48ì‹œê°„ |
| ë³µì› ë¹„ìš© | ë³„ë„ ê³¼ê¸ˆ (ìš©ëŸ‰ ê¸°ë°˜) |

### 3. mc mirrorì˜ --storage-class ì£¼ì˜

- `mc cp`ëŠ” `--storage-class` ì˜µì…˜ **ë¯¸ì§€ì›**
- `mc mirror`ë§Œ `--storage-class "DEEP_ARCHIVE"` ì‚¬ìš© ê°€ëŠ¥

---

## ğŸ’° ë¹„ìš© ì •ë³´

### ì˜ˆìƒ ì›” ë¹„ìš© (63GB ê¸°ì¤€)

| í•­ëª© | ë¹„ìš© |
| --- | --- |
| ì €ì¥ ìš”ê¸ˆ | 63GB Ã— $0.0012 = **$0.076/ì›”** |
| PUT ìš”ì²­ (ìµœì´ˆ) | ì•½ 1,000ê°œ ê°ì²´ Ã— $0.05/1000 = $0.05 (1íšŒì„±) |
| PUT ìš”ì²­ (ì¦ë¶„) | ì¦ë¶„ íŒŒì¼ë§Œ ì—…ë¡œë“œ (ë§¤ìš° ì €ë ´) |

**ì—°ê°„ ì˜ˆìƒ ë¹„ìš©**: ì•½ **$1 ì´í•˜**

### ë¹„ìš© ì ˆê° íš¨ê³¼

| ë°©ì‹ | ê°ì²´ ìˆ˜ | ì›” ì˜ˆìƒ ë¹„ìš© |
| --- | --- | --- |
| ì§ì ‘ ë°±ì—… (ê¸°ì¡´) | 25,950ê°œ | ë†’ìŒ (ì‘ì€ íŒŒì¼ í˜ë„í‹°) |
| **Restic (í˜„ì¬)** | **~1,000ê°œ** | **ë‚®ìŒ** (í° pack íŒŒì¼) |

---

## ğŸ“š ì°¸ê³  ìë£Œ

### ê³µì‹ ë¬¸ì„œ

- [Restic ê³µì‹ ë¬¸ì„œ](https://restic.readthedocs.io/)
- [AWS S3 Glacier Deep Archive ìš”ê¸ˆ](https://aws.amazon.com/ko/s3/pricing/)
- [MinIO Client (mc) ê°€ì´ë“œ](https://min.io/docs/minio/linux/reference/minio-mc.html)

### ë‚´ë¶€ ë¬¸ì„œ

- `restic-backup-immich.sh`: Restic ë°±ì—… ìŠ¤í¬ë¦½íŠ¸
- `restic-sync-to-s3.sh`: S3 ë™ê¸°í™” ìŠ¤í¬ë¦½íŠ¸
- `docker-volume-backup.sh`: Docker ë³¼ë¥¨ ë°±ì—… ìŠ¤í¬ë¦½íŠ¸

---

## ğŸ“Œ ë‹¤ìŒ ë‹¬ í™•ì¸ ì‚¬í•­ (2026-01-01)

- [ ]  í¬ë¡ íƒ­ ì •ìƒ ì‹¤í–‰ í™•ì¸
- [ ]  ì¦ë¶„ ë°±ì—… ì†Œìš” ì‹œê°„ ì¸¡ì •
- [ ]  S3 ì¦ë¶„ ë™ê¸°í™” ì†Œìš” ì‹œê°„ ì¸¡ì •
- [ ]  ë¡œê·¸ ì •ìƒ ê¸°ë¡ í™•ì¸
- [ ]  ìŠ¤ëƒ…ìƒ· ê°œìˆ˜ í™•ì¸ (ìë™ ì‚­ì œ ì •ì±… ê²€í† )
- [ ]  AWS ì²­êµ¬ì„œ í™•ì¸ (ì˜ˆìƒ ë¹„ìš©ê³¼ ë¹„êµ)

---

## ğŸ”„ íˆìŠ¤í† ë¦¬ ë©”ëª¨

### 2025-10-06: mc mirror ì‚¬ìš© ì¤‘ í˜¼ë€

- `mc cp`ì™€ `mc mirror`ì˜ `--storage-class` ì˜µì…˜ ì°¨ì´ë¡œ í˜¼ë€
- ë³µì¡í•œ ì˜ˆì™¸ ê·œì¹™ë³´ë‹¤ ë¹„ìš© ê°ë‹¹í•˜ê¸°ë¡œ ê²°ì •
- ê²°ë¡ : ì „ì²´ ë°ì´í„°ë¥¼ ì› ìŠ¤í¬ë¦½íŠ¸ë¡œ ë™ê¸°í™”í•˜ëŠ” ë°©ì‹ ìœ ì§€

### 2025-10-09: Restic ë„ì… ê²°ì •

- ê°ì²´ ìˆ˜ ë¬¸ì œ í•´ê²°ì„ ìœ„í•´ Restic ì„ íƒ
- Pack íŒŒì¼ ë°©ì‹ìœ¼ë¡œ S3 ê°ì²´ ìˆ˜ ìµœì†Œí™”
- ì´ˆê¸° í…ŒìŠ¤íŠ¸ ì„±ê³µ (50GB â†’ 779ê°œ pack)

### 2025-11-01: ì¦ë¶„ ë°±ì—… ê²€ì¦

- ì¦ë¶„ ë°±ì—… ì •ìƒ ì‘ë™ í™•ì¸ (+2.9GB)
- ë³€ê²½ëœ íŒŒì¼ë§Œ íš¨ìœ¨ì ìœ¼ë¡œ ì €ì¥

### 2025-12-27: ì™„ì „ ìë™í™” ë‹¬ì„±

- ìŠ¤í¬ë¦½íŠ¸ ì™„ì„± ë° í¬ë¡ íƒ­ ë“±ë¡
- íŒŒì¼ ê¶Œí•œ ì´ìŠˆ í•´ê²° (sudo ì œê±°)
- ë¡œê·¸ ì‹œìŠ¤í…œ êµ¬ì¶• (ìƒì„¸/ìš”ì•½ ë¶„ë¦¬)
- S3 ìµœì´ˆ ë™ê¸°í™” ì™„ë£Œ (1ì‹œê°„ 41ë¶„)
